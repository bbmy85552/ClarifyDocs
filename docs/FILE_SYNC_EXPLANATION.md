# 文件系统同步功能说明

## 问题背景

之前保存文档后，文档只存储在数据库中，但 Fumadocs 的导航栏是从 `content/docs/` 目录读取 MDX 文件来显示的。这导致新创建的文档不会出现在导航栏中。

## 解决方案

实现了**双重存储机制**：
1. **数据库** - 主要存储，支持快速 CRUD 操作
2. **文件系统** - 同步 MDX 文件，供 Fumadocs 读取

## 工作原理

### 1. 创建文档

```
用户创建文档
    ↓
保存到数据库 (documents 表)
    ↓
如果是 published 状态
    ↓
生成 MDX 文件到 content/docs/{slug}.mdx
    ↓
Fumadocs 自动读取并显示在导航栏
```

### 2. 更新文档

```
用户更新文档
    ↓
更新数据库记录
    ↓
如果是 published 状态
    ↓
覆盖 content/docs/{slug}.mdx
    ↓
Fumadocs 显示更新后的内容
```

### 3. 删除文档

```
用户删除文档
    ↓
从数据库删除记录
    ↓
删除 content/docs/{slug}.mdx
    ↓
导航栏中不再显示该文档
```

## 同步规则

### ✅ 会同步到文件系统

- **状态为 `published`** 的文档
- 创建、更新、删除操作都会同步

### ❌ 不会同步到文件系统

- **状态为 `draft`** 的文档（草稿）
- **状态为 `archived`** 的文档（归档）

**原因**：只有已发布的文档才应该在导航栏显示

## 文件格式

生成的 MDX 文件格式：

```markdown
---
title: 文档标题
description: 文档描述
---

# 文档内容

这里是用户输入的 MDX 内容...
```

## 实现细节

### API 端点

1. **POST /api/documents**
   - 创建文档
   - 如果 status=published，同步到文件系统

2. **PUT /api/documents/[id]**
   - 更新文档
   - 如果 status=published，同步到文件系统

3. **DELETE /api/documents/[id]**
   - 删除文档
   - 同时删除文件系统中的文件

### 代码位置

- `lib/document-sync.ts` - 同步工具函数
- `app/api/documents/route.ts` - 创建文档 API
- `app/api/documents/[id]/route.ts` - 更新/删除文档 API

### 错误处理

- 文件系统同步失败**不会**影响数据库操作
- 错误会记录到控制台，但用户仍能成功保存文档
- 这确保了系统的健壮性

## 使用示例

### 创建并发布文档

1. 访问 `/docs/new`
2. 填写标题和内容
3. 选择状态为 **"已发布"**
4. 点击"发布"按钮
5. ✅ 文档保存到数据库
6. ✅ MDX 文件生成到 `content/docs/`
7. ✅ 文档出现在导航栏

### 保存为草稿

1. 访问 `/docs/new`
2. 填写标题和内容
3. 选择状态为 **"草稿"**
4. 点击"保存草稿"按钮
5. ✅ 文档保存到数据库
6. ❌ 不生成文件（不在导航栏显示）
7. 后续可以在编辑页面发布

### 从草稿发布

1. 访问 `/docs/[id]/edit`
2. 修改内容（可选）
3. 将状态改为 **"已发布"**
4. 点击"发布"按钮
5. ✅ 数据库更新为 published
6. ✅ MDX 文件生成到 `content/docs/`
7. ✅ 文档出现在导航栏

## 注意事项

### 1. Slug 冲突

- Slug 在数据库中是唯一的
- 如果 slug 冲突，API 会返回错误
- 系统会自动生成带时间戳的 slug

### 2. 文件权限

确保 Next.js 有写入权限：
```bash
chmod +w content/docs/
```

### 3. Git 追踪

生成的 MDX 文件会被 Git 追踪，建议：
- 在 `.gitignore` 中忽略 `content/docs/*.mdx`
- 或者定期提交这些文件

### 4. 开发环境

在开发环境中：
- 修改文件后 Next.js 会自动重新加载
- 导航栏会实时更新

### 5. 生产环境

在生产环境中：
- 需要重新构建才能看到新文档
- 或者使用 ISR (Incremental Static Regeneration)

## 测试步骤

1. **创建草稿**
   ```bash
   访问 /docs/new
   保存为草稿
   检查：content/docs/ 目录没有新文件
   ```

2. **发布文档**
   ```bash
   访问 /docs/new
   填写内容并发布
   检查：content/docs/{slug}.mdx 文件已生成
   检查：导航栏显示新文档
   ```

3. **编辑文档**
   ```bash
   访问 /docs/{id}/edit
   修改内容并保存
   检查：content/docs/{slug}.mdx 已更新
   检查：导航栏显示更新后的标题
   ```

4. **删除文档**
   ```bash
   访问 /docs/{id}/edit
   点击删除
   检查：content/docs/{slug}.mdx 已删除
   检查：导航栏不再显示该文档
   ```

## 故障排除

### 问题1：文档保存成功但导航栏没有显示

**原因**：文档状态是 `draft`

**解决**：将文档状态改为 `published` 并重新保存

### 问题2：同步失败但文档保存成功

**原因**：文件系统权限或路径问题

**解决**：
1. 检查 `content/docs/` 目录是否存在
2. 检查是否有写入权限
3. 查看服务器控制台日志

### 问题3：文件已生成但导航栏不更新

**原因**：Next.js 缓存

**解决**：
1. 开发环境：等待自动重载
2. 生产环境：重新构建 `pnpm build`

## 后续优化

1. **实时同步** - 使用文件监听自动同步
2. **版本控制** - 记录文档修改历史
3. **批量操作** - 支持批量发布/归档
4. **自动清理** - 定期清理孤立的文件
5. **ISR 支持** - 增量静态重新生成

## 总结

现在文档创建/编辑流程是：

```
创建/编辑 → 保存到数据库 → (如果发布) → 生成 MDX 文件 → 显示在导航栏
```

这样既保证了数据库操作的灵活性，又确保了 Fumadocs 能够正常读取文档！
