# 🔧 MDX 编辑器问题排查和解决方案

## 问题说明

你遇到的问题：**编辑器没有报错，但保存后 MDX 解析失败**

### 根本原因

1. **MDX 解析发生在构建时**
   - 前端编辑器无法完全模拟 MDX 解析过程
   - 我们的验证是启发式的，无法捕获所有问题

2. **MDX 语法要求严格**
   - `{` 和 `}` 用于 JSX 表达式
   - `<` 和 `>` 用于 JSX 标签
   - 某些字符组合会被误解析

3. **双重存储机制**
   - 数据库：总是可以保存
   - 文件系统：只有正确的 MDX 才能生成文件

---

## ✅ 当前保护机制

### 1. 前端验证
编辑器会实时检测：
- Python 关键字（`import`, `def`, `class`）
- JavaScript 关键字（`const`, `let`, `function`）
- 代码模式（函数调用、括号嵌套等）

### 2. 保存时验证
点击"发布"时会：
- 检查未包裹的代码
- 阻止保存并显示错误

### 3. 错误处理
即使验证通过，如果同步失败：
- ✅ 数据库仍然会保存
- ❌ 文件系统不会生成
- ⚠️ 查看服务器日志了解详情

---

## 🎯 最佳实践

### 1. 先保存为草稿

```
步骤：
1. 填写标题和内容
2. 选择状态为"草稿"
3. 点击"保存草稿"
4. ✅ 保存到数据库（不会生成文件）
5. 编辑器中测试格式
6. 确认无误后，改为"已发布"
7. 点击"发布"
```

### 2. 使用正确的格式

#### ✅ 正确示例

```markdown
# 标题

## 代码示例

\`\`\`python
def hello():
    print("Hello")
\`\`\`

## 列表

- 项目 1
- 项目 2
```

#### ❌ 错误示例

```markdown
# 标题

def hello():  ← 这会导致解析错误！
    print("Hello")

- 项目 1
```

### 3. 调试技巧

#### 检查生成的文件

```bash
# 查看生成的文件
cat content/docs/test.mdx

# 如果有错误，删除文件
rm content/docs/test.mdx

# 然后在编辑器中修正格式
```

#### 查看服务器日志

```bash
# 终端中运行
pnpm dev

# 查看错误信息
```

---

## 🚨 常见错误和解决方案

### 错误 1: Unexpected character `!`

**原因**：某些字符在 MDX 中有特殊含义

**解决方案**：
- 确保该部分在代码块中
- 或转义特殊字符

### 错误 2: Could not parse import/exports

**原因**：`import` 语句未用代码块包裹

**解决方案**：
```
❌ import os
✅ ```python
   import os
   ```
```

### 错误 3: Unexpected token

**原因**：MDX 尝试将文本解析成 JavaScript

**解决方案**：
- 检查是否包含代码
- 用代码块包裹
- 或转义特殊字符

---

## 🛠️ 调试流程

### 步骤 1: 简单测试

先创建一个简单的文档测试：

```markdown
---
title: "测试"
description: "测试文档"
---

# 测试标题

这是一个测试文档。

## 代码测试

\`\`\`python
print("Hello")
\`\`\`
```

### 步骤 2: 逐步添加内容

1. 保存基础版本
2. 确认能正常显示
3. 逐步添加内容
4. 每次添加后保存测试

### 步骤 3: 如果出错

1. **删除错误文件**
   ```bash
   rm content/docs/你的文件名.mdx
   ```

2. **在编辑器中修正**

3. **重新发布**

---

## 💡 临时解决方案

如果实在无法解决 MDX 格式问题，可以：

### 方案 1: 只保存草稿

```
1. 保存为"草稿"状态
2. 文档保存在数据库中
3. 可以继续编辑
4. 不生成文件系统文件
```

### 方案 2: 手动创建文件

```
1. 在 content/docs/ 目录手动创建 .mdx 文件
2. 使用正确的格式
3. Fumadocs 会自动读取
```

### 方案 3: 禁用文件系统同步

修改 `app/api/documents/route.ts`，注释掉同步部分。

---

## 📝 未来改进

我们计划添加：

1. **实时 MDX 预览**
   - 在编辑器旁边显示预览
   - 实时看到渲染效果

2. **更智能的验证**
   - 集成实际的 MDX 解析器
   - 准确检测错误

3. **错误定位**
   - 精确指出错误位置
   - 提供修复建议

4. **自动修复**
   - 自动包裹未包裹的代码
   - 自动转义特殊字符

---

## 🎯 现在怎么做

1. **先保存草稿**
   - 填写内容
   - 选择"草稿"状态
   - 保存

2. **测试简单版本**
   ```markdown
   ---
   title: "我的第一个文档"
   ---

   # 欢迎使用

   这是我的第一个文档！
   ```

3. **逐步添加复杂内容**
   - 先添加纯文本
   - 再添加格式
   - 最后添加代码块

4. **每次保存后检查**
   - 查看是否出现错误
   - 如果出错，立即删除文件
   - 修正格式后重新发布

---

## 🆘 需要帮助？

如果仍然遇到问题：

1. 提供你尝试保存的内容
2. 提供完整的错误信息
3. 我们会帮你找到解决方案

记住：**草稿模式是安全的**，可以随时保存和修改！
